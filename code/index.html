<!doctype html>
<html lang="zh-Hant-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0, minimum-scale=1, maximum-scale=1, shrink-to-fit=no">
    <meta name="description" content="Python Level 2 Project">
    <meta name="author" content="Master Bug">
    <title>關於作者 | 圖書館管理系統1.0</title>
    <link rel="icon" href="/favicon.png">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/tomorrow-night.min.css">
    <link rel="stylesheet" href="/static/main.css?191223">
    <link rel="canonical" href="https://pyone.tw/">
  </head>

  <body>

    <div class="container">
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <div class="container">
          <h1 class="navbar-brand">圖書館管理系統1.0</h1>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav ml-auto">
              <li class="nav-item"> <a class="nav-link" href="/">首頁</a> </li>
              <li class="nav-item"> <a class="nav-link" href="/usage/">使用說明</a> </li>
              <li class="nav-item dropdown">
                <a class="nav-link active dropdown-toggle" href="/code/" id="navbardrop" data-toggle="dropdown">
                  程式碼
                </a>
                <div class="dropdown-menu">
                  <a class="dropdown-item" href="#acenter">圖書館</a>
                  <a class="dropdown-item" href="#auser">讀者</a>
                  <a class="dropdown-item" href="#adb">資料庫模組</a>
                </div>
              </li>
              <li class="nav-item"> <a class="nav-link" href="/database/">資料表</a> </li>
              <li class="nav-item"> <a class="nav-link" href="/aboutme/">關於作者</a> </li>
              <li class="nav-item"> <a class="nav-link" href="https://pyone.tw/" target="_blank">碼寶官網</a> </li>
              <li class="nav-item"> <a class="nav-link" href="https://github.com/micropyone/micropyone.github.io" target="_blank">GitHub</a> </li>
            </ul>
          </div>
        </div>
      </nav>

      <main role="main">
        <div class="row">
            <div class="col-lg-12 text-center">
                <h2 class="page-title">程式碼</h2>
            </div>
        </div>

        <div class="page-section" id="acenter"></div>
        <h3 class="text-center"><span>圖書館</span></h3>
        <pre>
            <code class="python"># acenter.py
from adb import DB

# import sqlite3
# conn = sqlite3.connect('library.db')
# cur = conn.cursor()

class Center():
    def __init__(self):
        self.menu_title = '圖書館管理系統1.0'
        self.menu = {
            'a':'查閱書庫',
            'b':'館藏書籍設定',
            # 'c':'填充題型設定',
            'd':'使用者列表',
            'e':'借閱統計',
            # 'f':'個人成績查詢',
            'q':'離開',
        }
        self.menu_func = {
            'a': lambda db, ft: self.search_book(db, ft),
            'b': lambda db, ft: self.set_books(db, ft),
            # 'c': lambda db, ft: self.C(db, ft),
            'd': lambda db, ft: self.D(db, ft),
            'e': lambda db, ft: self.E(db, ft),
            # 'f': lambda db, ft: self.F(db, ft),
        }
        self.divider = '='*20

    def show_menu(self):
        """ 主選單
        """
        print(self.divider)
        print(self.menu_title)
        print(self.divider)
        for fid, fname in self.menu.items():
            print('%s:%s' % (fid, fname))
        print(self.divider)
        opt = input('請選擇: ').lower()
        if opt in self.menu.keys():
            return opt, self.menu[opt]
        else:
            return '', '無此功能！'

    def search_book(self, db, func_title):
        db.show_books("SELECT * FROM BOOKS")

    def set_books(self, db):
        n = int(input('1.新增 2.刪除 3.查詢 4.列表'))
        if n == 1:
            pass
        if n == 2:
            pass
        if n == 3:
            pass
        if n == 4:
            pass
        else:
            print('Error')
        

    def C(self, db, func_title):
        pass

    def D(self, db, func_title):
        db.list_users()

    def E(self, db, func_title):
        pass

    def F(self, db, func_title):
        pass

# entry point
with DB() as db:
    atestcenter = Center()
    while True:
        func_id, func_name = atestcenter.show_menu()
        if func_id == 'q':
            break
        elif func_id == '':
            print(func_name)
        else:
            atestcenter.menu_func[func_id](db, func_name)
        print()
            </code>
        </pre>

        <div class="page-section" id="auser"></div>
        <h3 class="text-center"><span>讀者</span></h3>
        <pre>
            <code class="python"># auser.py
# auser.py
from adb import DB

# import sqlite3
# conn = sqlite3.connect('library.db')
# cur = conn.cursor()

class Examinee():
    def __init__(self):
        self.menu_title = '使用者'
        self.account = ''
        self.menu = {
            'l':'登入．註冊',
            'f':'書籍查詢',
            # 'c':'填充題測驗',
            'r':'歸還書籍',
            'c':'個人資料修改',
            # 'f':'推薦書籍',
            'q':'離開',
        }
        self.menu_func = {
            'l': lambda db, ft: self.login_or_signup(db, ft),
            'f': lambda db, ft: self.sear(db, self.account),
            # 'c': lambda db, ft: self.C(db, ft),
            'r': lambda db, ft: self.return_book(db),
            'c': lambda db, ft: self.F(db, ft),
            # 'f': lambda db, ft: self.G(db, ft),
        }
        self.divider = '='*20

    def show_menu(self, account=''):
        """ 主選單
        """
        print(self.divider)
        if self.account == '':
            print(self.menu_title, '尚未登入')
        else:
            print(self.menu_title, self.account)
            print('已借閱：')
            # db.show_item("SELECT * FROM BORROWED_BOOK WHERE USER LIKE ?", 0, self.account)
        print(self.divider)
        for fid, fname in self.menu.items():
            print('%s:%s' % (fid, fname))
        print(self.divider)
        opt = input('請選擇: ').lower()
        if opt in self.menu.keys():
            return opt, self.menu[opt]
        else:
            return '', '無此功能！'

    def login_or_signup(self, db, func_title):
        """ 登入．註冊
        """
        account_input = input('請輸入帳號: ')
        if db.check_if_examinee_existed(account_input):
            self.account = account_input
            db.print_examinee_info(self.account)
        else:
            db.insert_or_update_examinee(account_input)
            print()

    def sear(self, word_def, account):
        st =int(input("1.書名 2.作者: "))
        db.search_book(st, account)
        

    def P(self, db):
        pass

    def C(self, db, func_title):
        pass
            
    def return_book(self, db):
        db.show_item("SELECT * FROM BORROWED_BOOK WHERE USER LIKE ?", 0, self.account)
        n = input('輸入編號選擇書籍 q.返回: ')
        if n == 'q':
            pass
        elif n.isnumeric():
            pass

    def F(self, db, func_title):
        pass

    def G(self, db, func_title):
        pass

# entry point
with DB() as db:
    auser = Examinee()
    while True:
        func_id, func_name = auser.show_menu()
        if func_id == 'q':
            break
        elif func_id == '':
            print(func_name)
        else:
            if auser.account == '':
                func_id = 'l'
            auser.menu_func[func_id](db, func_name)
        print()
            </code>
        </pre>

        <div class="page-section" id="adb"></div>
        <h3 class="text-center"><span>資料庫模組</span></h3>
        <pre>
            <code class="python"># adb.py
class DB():
    def __init__(self):
        self.conn = None
        self.cur = None
        self.title_side = '-'*12

    def __enter__(self):
        self.open()
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        self.close()
        return False

    def open(self):
        """ 開啟資料庫連線
        """
        if self.conn is None:
            import sqlite3
            self.conn = sqlite3.connect('toeic.db')
            self.cur = self.conn.cursor()
        return True

    def close(self):
        """ 關閉資料庫連線
        """
        if self.conn is not None:
            self.conn.close()
            self.conn = None
        return True

    def count_words(self):
        """ 計算單字數
        """
        self.cur.execute("SELECT COUNT(*) FROM WORDS")
        return self.cur.fetchone()[0]

    def get_max_id(self, arg_table):
        """ 取得資料最新編號
        """
        self.cur.execute("SELECT MAX(ID) FROM {}".format(arg_table))
        return self.cur.fetchone()[0] + 1

    def list_all_words(self):
        """ 單字列表
        """
        self.cur.execute("SELECT * FROM WORDS")
        all_rows = self.cur.fetchall()
        for row in all_rows:
            print('{:04d} {}:'.format(row[0], row[1]))
            for item in row[2].split('||'):
                print('  ', item)
            print()
        print()

    def generate_dict_words(self):
        """ 設定單字字典
        """
        self.cur.execute("SELECT WORD, DEFINITIONS FROM WORDS")
        all_words = self.cur.fetchall()
        list_words = [dict(WORD=row[0], DEFS=row[1]) for row in all_words]
        return list_words

    def insert_or_update_word(self, arg_word, arg_def):
        """ 增修單字
        """
        words_max_id = self.get_max_id('WORDS')
        self.cur.execute("SELECT COUNT(*) FROM WORDS WHERE WORD=?", (arg_word,))
        count_result = self.cur.fetchone()[0]
        if count_result == 0:
            self.cur.execute("INSERT INTO WORDS VALUES (?, ?, ?)", 
                (words_max_id, arg_word, arg_def))
        elif count_result > 0:
            self.cur.execute("UPDATE WORDS SET DEFINITIONS=? WHERE WORD=?", (arg_def, arg_word))
        return self.conn.commit()

    def check_word_out(self, arg_word):
        """ 查詢單字
        """
        arg_word = '%'+arg_word+'%'
        self.cur.execute("SELECT * FROM WORDS WHERE WORD LIKE ?", (arg_word,))
        result = self.cur.fetchall()
        for word in result:
            print('{:04d} {}:'.format(word[0], word[1]))
            for item in word[2].split('||'):
                print('  ', item)
            print()

    def delete_word(self, arg_word):
        """ 刪除單字
        """         
        self.cur.execute("DELETE FROM WORDS WHERE WORD=?", (arg_word,))
        return self.conn.commit()

    def get_settings(self, arg_type, arg_opt):
        """ 擷取題型設定
        """
        self.cur.execute("SELECT OPTION, NUM_OF_QUESTIONS FROM SETTINGS WHERE TYPE=?", (arg_type,))
        settings = self.cur.fetchone()
        print('設定選項:%s 題數:%s' % settings)
        if arg_opt == 'read':
            return settings

    def update_settings(self, arg_type, arg_qnum, arg_opt):
        """ 更新題型設定
        """
        self.cur.execute("UPDATE SETTINGS SET NUM_OF_QUESTIONS=?, OPTION=? WHERE TYPE=?", 
            (arg_qnum, arg_opt, arg_type))
        return self.conn.commit()

    def list_all_examinees(self):
        """ 考生列表
        """
        self.cur.execute("SELECT * FROM EXAMINEES")
        all_rows = self.cur.fetchall()
        print('{:3} {:8} {:18} {:4} {:6}'.format('ID', '帳號', '姓名', '性別', '出生年'))
        print('-'*50)
        for row in all_rows:
            print('{:3} {:10} {:20} {:<4} {:6}'.format(*row))
        print()

    def check_if_examinee_existed(self, arg_account):
        """ 檢查考生是否註冊
        """
        self.cur.execute("SELECT COUNT(*) FROM EXAMINEES WHERE ACCOUNT=?", (arg_account,))
        if self.cur.fetchone()[0] == 1:
            return True
        else:
            return False

    def insert_or_update_examinee(self, account_id, action):
        """ 增修考生
        """
        data_ok = True
        full_name = input('姓名: ')
        if full_name == 'q':
            return False

        gender = input('性別(F.女性 M.男性): ').upper()
        if gender not in ('F', 'M'):
            data_ok = False

        birth_year = input('出生年 (1970~2020): ')
        if birth_year.isdigit():
            birth_year = int(birth_year)
            if birth_year not in range(1950, 2020):
                data_ok = False
        else:
            data_ok = False

        # 資料無誤，准許註冊
        if data_ok:
            if action == 'insert':
                examinees_max_id = self.get_max_id('EXAMINEES')
                self.cur.execute("INSERT INTO EXAMINEES VALUES (?, ?, ?, ?, ?)", 
                    (examinees_max_id, account_id, full_name, gender, birth_year))
            elif action == 'update':
                self.cur.execute("UPDATE EXAMINEES SET NAME=?, GENDER=?, BIRTH_YEAR=? WHERE ACCOUNT=?", 
                    (full_name, gender, birth_year, account_id))
            self.conn.commit()
            return True
        else:
            return False
                        
    def print_examinee_info(self, account):
        """ 查詢考生資訊
        """
        self.cur.execute("SELECT * FROM EXAMINEES WHERE ACCOUNT=?", (account,))
        examinee = self.cur.fetchone()
        print('編號: {}  帳號: {}\n姓名: {}\n性別: {}\n出生年: {}'.format(*examinee))

    def insert_score(self, account, ex_type, ex_score):
        """ 增修單字
        """
        scores_max_id = self.get_max_id('SCORES')
        self.cur.execute("INSERT INTO SCORES VALUES (?, ?, ?, ?, date('now'))", 
            (scores_max_id, account, ex_type, ex_score))
        return self.conn.commit()

    def sql_case_type(self):
        return '''CASE TYPE WHEN 'multiple_choice' THEN '選擇題' 
                            WHEN 'fill_in_the_blank' THEN '填空題' END TYPE'''
    
    def show_one_score(self, row):
        print('{:3} {:10} {:3} {:4} {:10}'.format(*row))

    def list_scores_by_account(self, account):
        """ 個人成績查詢
        """
        case_type = self.sql_case_type()
        account_like = ''.join(('%', account, '%'))

        self.cur.execute('''SELECT ID, ACCOUNT, {}, SCORE, DATE_TIME FROM SCORES 
            WHERE ACCOUNT LIKE ? ORDER BY DATE_TIME DESC'''.format(case_type), (account_like,))
        all_rows = self.cur.fetchall()
        if len(all_rows):
            for row in all_rows:
                self.show_one_score(row)
        else:
            print(account, '查無任何成績')

    def score_summary(self):
        """ 測驗成績統計
        """
        case_type = self.sql_case_type()

        print(self.title_side, '測驗人數及平均分數', self.title_side)
        sql = "SELECT {}, COUNT(*), AVG(SCORE) FROM SCORES GROUP BY TYPE"
        self.cur.execute(sql.format(case_type))
        all_rows = self.cur.fetchall()
        if len(all_rows):
            for row in all_rows:
                print('{:3} {:4} {:6}'.format(*row))
        print(self.title_side, '成績列表依日期降冪', self.title_side)
        sql = "SELECT ID, ACCOUNT, {}, SCORE, DATE_TIME FROM SCORES ORDER BY DATE_TIME DESC"
        self.cur.execute(sql.format(case_type))
        all_rows = self.cur.fetchall()
        if len(all_rows):
            for row in all_rows:
                self.show_one_score(row)

if __name__ == '__main__':
    print('This is the DB class.')
            </code>
        </pre>
      </main>

      <hr>
      <footer class="footer">
        <p>&copy; 2020 碼寶程式教育中心</p>
      </footer>
    </div> <!-- /container -->

    <script src="/static/jquery.slim.min.js"></script>
    <script src="/static/popper.min.js"></script>
    <script src="/static/bootstrap.min.js"></script>
    <script src="/static/highlight.min.js"></script>
    <script src="/static/highlightjs-line-numbers.min.js"></script>
    <script src="/static/main.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
        hljs.initLineNumbersOnLoad();
    </script>
  </body>
</html>
